
# Основное
Научная работа на тему "Автоматическое составление расписания занятий в университете"
# Постановка задачи
Пyсть даны: 
+ _T_ - Множество преподавателей
+ _G_ - Множество групп
+ _S_ - Множество предметов
+ _R_ - Множество доступных комнат для проведения занятий
+ _L_ - Множество моментов времени для проведения занятий
+ _a<sub>s</sub><sub>g</sub>_ - число занятий, по предмету _s_, которые нужно провести у группы _g_ в рамках горизонта планирования <p>
Задача: для каждой пары $`(g, s): g \in G,  s \in S`$ указать ровно _a<sub>s</sub><sub>g</sub>_ троек $`(t, r, l): t \in T, r \in R, l \in L`$, так, чтобы <p>
$` \forall (g_1, s_1), (g_2, s_2) \implies`$
1. $`g_1 \neq g_2 \implies (l_1 = l_2 \implies r_1 \neq r_2 \vee t_1 \neq t_2)`$
2. $`g_1 = g_2 \implies (l_1 \neq l_2)`$

Помимо этого в данной задаче фигурирует ряд дополнительных условий, не обязательных, но желательных к выполнению. Мы сконцентрируемся на следyющих
1. Отсутствие "окон" в расписании
2. $` \forall (g, s) \implies (\forall (t_1, r_1, l_1), \quad (t_2, r_2, l_2) \implies t_1 = t_2) `$
3. Для каждой пары $` (g, s) `$ существует подмножества, исходных множеств преподавателей, комнат и моментов времени, которые нельзя использовать в соотвествующей этой паре тройке
4. Группы могут объеденены
5. ...

# Основа решения
## 1. Представление данных
Преподаватели, предметы, группы, комнаты, моменты времени будет считать целыми числами от 0 до $`|T|-1`$, $`|S|-1`$, $`|G|-1`$, $`|R|-1`$, $`|L|-1`$, соотвественно. При этом под моментом времени
будем понимать, пару в расписании, таким образом мы условно считаем что эти не разграниченны днями, тем не менее по числу l можно легко получить номер дня и номер пары в рамаках этого дня, соотвествующие l.

Если в течении одного дня можно провести не более чем _p_ пар, то числу l соотвествует $`(l \mod p)`$-ая пара, $`(l \div p)`$-ого дня. 

Пример входных данных
```python
    rooms = 3
    subjects = 4
    teacher = 19
    lessons = 30
    groups = 14
    subjectGroup = [[0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0],
                    [2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0]]
```
## 2. Упрощенная задача
Для начала решим упрощенную задачу в которой нет преподаватлей, а так же не учитываются доп условия

Пусть $`sch[r, s, l, g]`$ - бинарная переменная, равна 1, если у группы _g_ проходит пара по предмету _s_ в кабинете _r_ в момент _l_. 0 иначе. <p> 
Выразим два основных условия на эти переменные 

$`\forall g \in G, \quad l \in L \implies \displaystyle\sum_{s \in S, r \in R} sch[r, s, l, g] \leq 1`$ 

$`\forall r \in R, \quad l \in L \implies \displaystyle\sum_{g \in G, r \in R} sch[r, s, l, g] \leq 1`$

А также условие на необходимое число занятий по каждому предмету

$`\forall g \in G, \quad s \in S \implies \displaystyle\sum_{l \in L, r \in R} sch[r, s, l, g] == a_{sg}`$

Решить задачу - значит задать все возможнные переменные $`sch[r, s, l, g]`$ удовлетворяющие данным условиям. Это задачу не трудно решить как задачу линейного целочисленного программирования.
## 3. Объеденения групп
Пycть помимо обычных пар, которые проходят только у одной группы, y нас есть пары которые должны проходить у нескольких групп сразу. Чтобы это учесть, мы введем фиктивные переменные $`ug_{i}`$ в множество G, в количестве равному числу различных объеденений групп.

Теперь каждой группе (как фиктивной, так и настоящей) сопоставим множество $` unity[g] `$, которое содержит сам элемент g, а так же все элементы ug, такие что ug отвечает объеденению, содержащему группу g. 

Пример:
```python
 casual_groups = 9 # настоящие переменные
 lecture_groups = 5 # фиктивные
 subGroup = {9: [0, 1, 2], 10: [3, 4, 5], 11: [6, 7, 8], 12: [0, 1, 2, 3], 13: [4, 5, 6, 7, 8]} # список объединений
 unity = {0: [0, 9, 12], 1: [1, 9, 12], 2: [2, 9, 12], 3: [3, 10, 12], 4: [4, 10, 13], 5: [5, 10, 13], 6: [6, 11, 13], 7: [7, 11, 13], 8: [8, 11, 13], 9: [9], 10: [10], 11: [11], 12: [12], 13: [13]}
```
Теперь, чтобы учесть необходимые ограничения достаточно, заменить первые ограничения на

$`\forall g \in G, \quad l \in L \implies \displaystyle\sum_{s \in S,r \in R, \quad ug \in unity[g]} sch[r, s, l, ug] \leq 1 `$
## 4. Cпецифика кабинетов
Чтобы учесть, что не каждый кабинет (момент времени) пригоден для проведения того или иного предмета, мы заранее назначим $`sch[r, s, l, g] = 0`$, если предмет _s_ нельзя проводить в кабинете _r_ (в момент _l_)

## 5. Условие кластеризации
Теперь рассмотрим метод борьбы с появлением окон относительно групп. Зафиксируем группу _g_, введем в рассмотрение две переменные
$` A(l)`$ - равняется 1 если в момент _l_ в течении этого дня мы уже поставили хотя 1 пару, 0 иначе
$` B(l)`$ - равняется 1 если в момент _l - 1_ мы поставили пару, 0 иначе 
Заметим что для $`l : (l \mod p) \geq 1`$ уcловие $`A(l) == 1 \vee B(l) == 0`$, говорит о том, что поставив какую либо пару группе _g_, мы создадим окно (в момент времени _l - 1_)
Таким образом при выполнение данного условия, мы должны убедится, что мы не поставим данной группе пару в момент _l_

Выразим это условие как линейное ограничение

$` A(l) - B(l) + \displaystyle\sum_{s \in S, r \in R} sch[r, s, l, g] \leq 1`$

Теперь найдем выражение $`A(l), B(l)`$ через переменные _sch[r, s, l, g]_

$` A(l) =  \displaystyle\max_{r \in R,s \in S, \quad l_i \in (d \dots l - 2)}(sch[r, s, l_i, g]) `$, где $` d = l \div p `$

$` B(l) = \displaystyle\sum_{s \in S, r \in R} sch[r, s, l - 1, g]`$

Таким образом, мы получаем условие кластеризации пар относительно групп
$` \displaystyle\max_{r \in R,s \in S, \quad l_i \in (d  \dots l - 2)}(sch[r, s, l_i, g]) - \displaystyle\sum_{s \in S, r \in R} sch[r, s, l - 1, g] + \displaystyle\sum_{s \in S, r \in R} sch[r, s, l, g] \leq 1 \quad \forall l: (l \mod p) \geq 2, g \in G `$
## 6. Приоритет во времени, плотность расписания
Рассмотрим альтернативный способ борьбы с окнами. Будем считать, что момент в начале дня, имеют больший приоритет, чтобы это реализовать, добавим в нашу задачу целевую функцию
которую мы будем минимализировать

$` F =  \displaystyle\sum_{s \in S, r \in R, l \in L, g \in G} sch[r, s, l, g] * (l \mod p)`$

Предполагается, что решение доставляющие минимум данной функции, будет содержать допустимо малое число окон. Введем также в рассмотрение величину $` D = \displaystyle\sum_{g \in G, s \in S} a_{sg} \div (|G| * |R|) `$ - плотность расписания. Эксперементы показывают, что при _D ~ 0_, данная эврестика позволяет найти решение с крайне малым числом окон. Этот факт можно использовать для оптимизации работы алгоритма. Первая из них, - отказать от поиска минимума целевой функции, но добавить ограничение $` F <= eps (D) `$
где $`eps (D)`$ положительная функция, которая монотонно возрастает при увеличении D.
# Пример
```python
lecture_rooms = 3
    casual_rooms = 3

    subjects = 11
    lessons = 30
    casual_groups = 9
    lecture_groups = 5
    subjectGroup = [[0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0],
                    [2, 2, 2, 2, 2, 2, 2, 2, 2, 0, 0, 0, 0, 0],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 2, 0, 0],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 0, 0, 0, 0],
                    [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0]
                    ]
    subGroup = {9: [0, 1, 2], 10: [3, 4, 5], 11: [6, 7, 8], 12: [0, 1, 2, 3], 13: [4, 5, 6, 7, 8]}

  ...
  ans = "расписания на день 1 пара № 1

расписания на день 1 пара № 2
s4 проходит y грyппы g2 в kабинете cr2
s3 проходит y грyппы ['g7', 'g8', 'g9'] в kабинете lr4

расписания на день 1 пара № 3
s1 проходит y грyппы ['g1', 'g2', 'g3'] в kабинете lr4
s10 проходит y грyппы ['g5', 'g6', 'g7', 'g8', 'g9'] в kабинете lr5

расписания на день 1 пара № 4
s8 проходит y грyппы g7 в kабинете cr1
s11 проходит y грyппы g8 в kабинете cr2
s7 проходит y грyппы g9 в kабинете cr3
s2 проходит y грyппы ['g4', 'g5', 'g6'] в kабинете lr5
s3 проходит y грyппы ['g1', 'g2', 'g3'] в kабинете lr6

расписания на день 1 пара № 5
s11 проходит y грyппы g4 в kабинете cr1
s11 проходит y грyппы g3 в kабинете cr2
s7 проходит y грyппы g6 в kабинете cr3
s6 проходит y грyппы ['g7', 'g8', 'g9'] в kабинете lr4

расписания на день 2 пара № 1
s8 проходит y грyппы g6 в kабинете cr1
s7 проходит y грyппы g5 в kабинете cr2
s3 проходит y грyппы ['g7', 'g8', 'g9'] в kабинете lr4

расписания на день 2 пара № 2
s8 проходит y грyппы g5 в kабинете cr1
s4 проходит y грyппы g6 в kабинете cr3
s2 проходит y грyппы ['g7', 'g8', 'g9'] в kабинете lr6

расписания на день 2 пара № 3
s8 проходит y грyппы g1 в kабинете cr1
s4 проходит y грyппы g5 в kабинете cr2
s4 проходит y грyппы g6 в kабинете cr3
s2 проходит y грyппы ['g7', 'g8', 'g9'] в kабинете lr6

расписания на день 2 пара № 4
s5 проходит y грyппы g1 в kабинете cr1
s4 проходит y грyппы g4 в kабинете cr2
s4 проходит y грyппы g2 в kабинете cr3
s10 проходит y грyппы ['g5', 'g6', 'g7', 'g8', 'g9'] в kабинете lr4

расписания на день 2 пара № 5
s5 проходит y грyппы g7 в kабинете cr1
s8 проходит y грyппы g2 в kабинете cr2
s4 проходит y грyппы g1 в kабинете cr3
s3 проходит y грyппы ['g4', 'g5', 'g6'] в kабинете lr6

расписания на день 3 пара № 1
s3 проходит y грyппы ['g4', 'g5', 'g6'] в kабинете lr4

расписания на день 3 пара № 2
s4 проходит y грyппы g1 в kабинете cr1
s4 проходит y грyппы g3 в kабинете cr2
s2 проходит y грyппы ['g4', 'g5', 'g6'] в kабинете lr5

расписания на день 3 пара № 3
s4 проходит y грyппы g8 в kабинете cr2
s9 проходит y грyппы ['g4', 'g5', 'g6'] в kабинете lr4
s9 проходит y грyппы ['g1', 'g2', 'g3'] в kабинете lr6

расписания на день 3 пара № 4
s8 проходит y грyппы g9 в kабинете cr1
s4 проходит y грyппы g3 в kабинете cr2
s4 проходит y грyппы g8 в kабинете cr3
s6 проходит y грyппы ['g4', 'g5', 'g6'] в kабинете lr4

расписания на день 3 пара № 5
s5 проходит y грyппы g3 в kабинете cr1
s11 проходит y грyппы g7 в kабинете cr2
s4 проходит y грyппы g9 в kабинете cr3
s1 проходит y грyппы ['g4', 'g5', 'g6'] в kабинете lr4

расписания на день 4 пара № 1

расписания на день 4 пара № 2
s7 проходит y грyппы g3 в kабинете cr2

расписания на день 4 пара № 3
s7 проходит y грyппы g2 в kабинете cr2

расписания на день 4 пара № 4
s11 проходит y грyппы g9 в kабинете cr1
s11 проходит y грyппы g1 в kабинете cr2
s5 проходит y грyппы g8 в kабинете cr3

расписания на день 4 пара № 5
s7 проходит y грyппы g4 в kабинете cr1
s8 проходит y грyппы g8 в kабинете cr2
s4 проходит y грyппы g7 в kабинете cr3

расписания на день 5 пара № 1
s1 проходит y грyппы ['g7', 'g8', 'g9'] в kабинете lr4

расписания на день 5 пара № 2
s5 проходит y грyппы g9 в kабинете cr1
s7 проходит y грyппы g8 в kабинете cr2
s4 проходит y грyппы g7 в kабинете cr3

расписания на день 5 пара № 3
s11 проходит y грyппы g2 в kабинете cr2
s6 проходит y грyппы ['g7', 'g8', 'g9'] в kабинете lr4

расписания на день 5 пара № 4
s4 проходит y грyппы g9 в kабинете cr1
s11 проходит y грyппы g5 в kабинете cr2
s5 проходит y грyппы g4 в kабинете cr3
s6 проходит y грyппы ['g1', 'g2', 'g3'] в kабинете lr4

расписания на день 5 пара № 5
s5 проходит y грyппы g6 в kабинете cr1
s4 проходит y грyппы g5 в kабинете cr3
s6 проходит y грyппы ['g1', 'g2', 'g3'] в kабинете lr4

расписания на день 6 пара № 1
s9 проходит y грyппы ['g7', 'g8', 'g9'] в kабинете lr4

расписания на день 6 пара № 2
s7 проходит y грyппы g7 в kабинете cr1
s2 проходит y грyппы ['g1', 'g2', 'g3'] в kабинете lr4

расписания на день 6 пара № 3
s11 проходит y грyппы g6 в kабинете cr2
s4 проходит y грyппы g4 в kабинете cr3
s2 проходит y грyппы ['g1', 'g2', 'g3'] в kабинете lr4

расписания на день 6 пара № 4
s7 проходит y грyппы g1 в kабинете cr1
s8 проходит y грyппы g3 в kабинете cr2
s5 проходит y грyппы g2 в kабинете cr3
s6 проходит y грyппы ['g4', 'g5', 'g6'] в kабинете lr4

расписания на день 6 пара № 5
s8 проходит y грyппы g4 в kабинете cr2
s5 проходит y грyппы g5 в kабинете cr3
s3 проходит y грyппы ['g1', 'g2', 'g3'] в kабинете lr4"
```
ук
